<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trinket-like Python Runner</title>

  <!-- CodeMirror 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.js"></script>

  <style>
    body { margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: system-ui, sans-serif; }
    header { display: flex; gap: 10px; align-items: center; padding: 10px 12px; border-bottom: 1px solid #ddd; }
    #status { color: #666; font-size: 14px; }
    .spacer { flex: 1; }
    button { padding: 8px 12px; cursor: pointer; }

    #app { flex: 1; display: flex; min-height: 0; }
    #left, #right { width: 50%; display: flex; flex-direction: column; min-height: 0; }
    #left { border-right: 1px solid #ddd; }
    .pane-title { padding: 8px 12px; font-size: 14px; color: #444; border-bottom: 1px solid #eee; }

    #editorWrap { flex: 1; min-height: 0; }
    .CodeMirror { height: 100% !important; }

    /* Terminal pane */
    #terminalWrap { flex: 1; min-height: 0; background: #0b0b0b; }
    #terminal { width: 100%; height: 100%; }
  </style>
</head>

<body>
<header>
  <button id="run" disabled>Run ▶</button>
  <button id="clear" disabled>Clear</button>
  <div class="spacer"></div>
  <div id="status">Starting…</div>
</header>

<div id="app">
  <section id="left">
    <div class="pane-title">main.py</div>
    <div id="editorWrap"><textarea id="editor"></textarea></div>
  </section>

  <section id="right">
    <div class="pane-title">Console</div>
    <div id="terminalWrap"><div id="terminal"></div></div>
  </section>
</div>

<script type="module">
  import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.mjs";

  // ✅ xterm as ESM (no global Terminal needed)
  import { Terminal } from "https://cdn.jsdelivr.net/npm/xterm@5.5.0/+esm";
  import { FitAddon } from "https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.10.0/+esm";
  import "https://cdn.jsdelivr.net/npm/xterm@5.5.0/css/xterm.css";

  const runBtn = document.getElementById("run");
  const clearBtn = document.getElementById("clear");
  const statusEl = document.getElementById("status");
  const setStatus = (s) => (statusEl.textContent = s);

  // --- CodeMirror
  if (!window.CodeMirror) {
    setStatus("Editor failed");
    throw new Error("CodeMirror not loaded (CDN blocked?)");
  }
  const cm = CodeMirror.fromTextArea(document.getElementById("editor"), {
    mode: "python",
    lineNumbers: true,
    indentUnit: 4,
    tabSize: 4
  });
  cm.setSize(null, "100%");

  async function loadInitialCode() {
    const res = await fetch("./main.py", { cache: "no-store" });
    if (!res.ok) throw new Error(`Could not load main.py (HTTP ${res.status})`);
    cm.setValue(await res.text());
  }

  // --- Terminal
  const term = new Terminal({
    convertEol: true,
    cursorBlink: true,
    fontSize: 14,
    fontFamily: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace',
  });
  const fit = new FitAddon();
  term.loadAddon(fit);
  term.open(document.getElementById("terminal"));
  fit.fit();
  window.addEventListener("resize", () => fit.fit());

  clearBtn.onclick = () => term.reset();

  // --- Terminal line input (single window, Trinket-like)
  let inputActive = false;
  let inputBuffer = "";
  let inputResolver = null;

  function termInput(promptText) {
    inputActive = true;
    inputBuffer = "";
    if (promptText) term.write(String(promptText));
    return new Promise((resolve) => (inputResolver = resolve));
  }

  function finishInput(line) {
    const resolve = inputResolver;
    inputActive = false;
    inputBuffer = "";
    inputResolver = null;
    if (resolve) resolve(line);
  }

  term.onData((data) => {
    if (!inputActive) return;

    // Enter
    if (data === "\r") {
      term.write("\r\n");
      finishInput(inputBuffer);
      return;
    }

    // Backspace (DEL)
    if (data === "\u007F") {
      if (inputBuffer.length > 0) {
        inputBuffer = inputBuffer.slice(0, -1);
        term.write("\b \b");
      }
      return;
    }

    // Ctrl+C
    if (data === "\u0003") {
      term.write("^C\r\n");
      finishInput("");
      return;
    }

    // Ignore other control chars
    if (data < " " || data === "\u0000") return;

    // Normal text
    inputBuffer += data;
    term.write(data);
  });

  // --- Pyodide
  setStatus("Loading Python…");
  const pyodide = await loadPyodide();

  pyodide.setStdout({ batched: (s) => term.writeln(s) });
  pyodide.setStderr({ batched: (s) => term.writeln(s) });

  // Provide async input() backed by terminal
  pyodide.globals.set("__term_input__", termInput);

  await pyodide.runPythonAsync(`
import builtins
async def _input(prompt=""):
    return await __term_input__(str(prompt))
builtins.input = _input
  `.trim());

  // Wrap code so plain input() becomes await input()
  function wrapUserCode(src) {
    const transformed = src.replace(/(^|[^\w.])input\s*\(/g, "$1await input(");
    const indented = transformed.split("\n").map(l => "    " + l);
    return ["async def __main__():", ...indented, "", "await __main__()"].join("\n");
  }

  // Load initial code
  try {
    await loadInitialCode();
  } catch (e) {
    term.writeln(String(e));
    cm.setValue(`print("main.py missing")\nname = input("Your name? ")\nprint("Hi", name)\n`);
  }

  setStatus("Ready");
  runBtn.disabled = false;
  clearBtn.disabled = false;

  runBtn.onclick = async () => {
    runBtn.disabled = true;
    setStatus("Running…");
    try {
      await pyodide.runPythonAsync(wrapUserCode(cm.getValue()));
      setStatus("Done");
    } catch (e) {
      setStatus("Error");
      term.writeln(String(e));
    } finally {
      runBtn.disabled = false;
      term.focus();
    }
  };

  document.getElementById("terminalWrap").addEventListener("mousedown", () => term.focus());
  term.focus();
</script>
</body>
</html>
