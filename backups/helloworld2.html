<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Python Runner (Console-style)</title>

  <style>
    body { margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: system-ui, sans-serif; }
    header { display: flex; gap: 10px; align-items: center; padding: 10px 12px; border-bottom: 1px solid #ddd; }
    #status { color: #666; font-size: 14px; }
    .spacer { flex: 1; }
    button { padding: 8px 12px; cursor: pointer; }

    #app { flex: 1; display: flex; min-height: 0; }
    #left, #right { width: 50%; display: flex; flex-direction: column; min-height: 0; }
    #left { border-right: 1px solid #ddd; }
    .pane-title { padding: 8px 12px; font-size: 14px; color: #444; border-bottom: 1px solid #eee; }

    /* Editor (simple textarea — reliable) */
    textarea {
      flex: 1;
      width: 100%;
      border: 0;
      outline: none;
      resize: none;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
      line-height: 1.4;
    }

    /* Console */
    #consoleWrap { flex: 1; min-height: 0; background: #0b0b0b; }
    #console {
      height: 100%;
      padding: 12px;
      overflow: auto;
      color: #eaeaea;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-word;
      outline: none;
      cursor: text;
      user-select: text;
    }

    /* Fake caret */
    .caret {
      display: inline-block;
      width: 8px;
      margin-left: 1px;
      background: #eaeaea;
      animation: blink 1s steps(1) infinite;
      vertical-align: -2px;
      height: 1em;
    }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>

<body>
<header>
  <button id="run" disabled>Run ▶</button>
  <button id="clear" disabled>Clear</button>
  <div class="spacer"></div>
  <div id="status">Loading Python…</div>
</header>

<div id="app">
  <section id="left">
    <div class="pane-title">main.py</div>
    <textarea id="code" spellcheck="false"></textarea>
  </section>

  <section id="right">
    <div class="pane-title">Console (click here and type when prompted)</div>
    <div id="consoleWrap">
      <div id="console" tabindex="0"></div>
    </div>
  </section>
</div>

<script type="module">
  import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.mjs";

  const runBtn = document.getElementById("run");
  const clearBtn = document.getElementById("clear");
  const statusEl = document.getElementById("status");
  const codeEl = document.getElementById("code");
  const consoleEl = document.getElementById("console");

  const setStatus = (s) => (statusEl.textContent = s);

  function scrollConsoleToBottom() {
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  function clearConsole() {
    consoleEl.textContent = "";
  }

  function writeToConsole(s) {
    // Remove caret if present, write, then restore caret if we’re in input mode
    removeCaret();
    consoleEl.textContent += s;
    if (inputActive) renderCaret();
    scrollConsoleToBottom();
  }

  function writelnToConsole(s) {
    writeToConsole((s ?? "") + "\n");
  }

  clearBtn.onclick = () => {
    clearConsole();
    consoleEl.focus();
  };

  // --- Load initial main.py into editor
  async function loadInitialCode() {
    try {
      const res = await fetch("./main.py", { cache: "no-store" });
      if (!res.ok) throw new Error(`main.py not found (HTTP ${res.status})`);
      codeEl.value = await res.text();
    } catch (e) {
      codeEl.value =
`print("Welcome!")
name = input("Your name? ")
print("Hello,", name)
`;
      writelnToConsole(String(e));
    }
  }

  // --- Inline console input (single window)
  let inputActive = false;
  let inputBuffer = "";
  let inputResolve = null;

  function removeCaret() {
    const caret = consoleEl.querySelector(".caret");
    if (caret) caret.remove();
  }

  function renderCaret() {
    removeCaret();
    const caret = document.createElement("span");
    caret.className = "caret";
    consoleEl.appendChild(caret);
  }

  function beginInput(promptText) {
    inputActive = true;
    inputBuffer = "";
    if (promptText) writeToConsole(String(promptText));
    renderCaret();
    consoleEl.focus();

    return new Promise((resolve) => {
      inputResolve = resolve;
    });
  }

  function finishInput() {
    inputActive = false;
    removeCaret();
    const resolve = inputResolve;
    inputResolve = null;
    if (resolve) resolve(inputBuffer);
  }

  consoleEl.addEventListener("keydown", (e) => {
    if (!inputActive) return;

    // Prevent page scrolling on space etc.
    e.preventDefault();

    if (e.key === "Enter") {
      writeToConsole("\n");
      finishInput();
      return;
    }

    if (e.key === "Backspace") {
      if (inputBuffer.length > 0) {
        inputBuffer = inputBuffer.slice(0, -1);

        // Remove last character from console text (before caret)
        removeCaret();
        const t = consoleEl.textContent;
        consoleEl.textContent = t.slice(0, -1);
        renderCaret();
        scrollConsoleToBottom();
      }
      return;
    }

    // Basic Ctrl+C behavior: cancel input, return empty line
    if (e.ctrlKey && (e.key === "c" || e.key === "C")) {
      writeToConsole("^C\n");
      inputBuffer = "";
      finishInput();
      return;
    }

    // Printable characters
    if (e.key.length === 1 && !e.metaKey && !e.altKey) {
      inputBuffer += e.key;
      writeToConsole(e.key);
    }
  });

  consoleEl.addEventListener("mousedown", () => consoleEl.focus());

  // --- Transform: allow students to write normal input(), but we run it async
  function wrapUserCode(src) {
    // Turn input(...) into await input(...)
    const transformed = src.replace(/(^|[^\w.])input\s*\(/g, "$1await input(");
    const indented = transformed.split("\n").map(l => "    " + l);
    return [
      "async def __main__():",
      ...indented,
      "",
      "await __main__()"
    ].join("\n");
  }

  // --- Load Pyodide
  setStatus("Loading Python…");
  let pyodide;
  try {
    pyodide = await loadPyodide();
  } catch (e) {
    setStatus("Pyodide failed to load");
    writelnToConsole(String(e));
    throw e;
  }

  // stdout/stderr -> our console
  pyodide.setStdout({ batched: (s) => writelnToConsole(s) });
  pyodide.setStderr({ batched: (s) => writelnToConsole(s) });

  // Provide async input() backed by our console
  pyodide.globals.set("__console_input__", beginInput);

  await pyodide.runPythonAsync(`
import builtins

async def _input(prompt=""):
    return await __console_input__(str(prompt))

builtins.input = _input
  `.trim());

  await loadInitialCode();

  setStatus("Ready");
  runBtn.disabled = false;
  clearBtn.disabled = false;

  runBtn.onclick = async () => {
    runBtn.disabled = true;
    setStatus("Running…");
    try {
      // Start run on a clean line if caret/typing was mid-state
      if (inputActive) {
        // If somehow already waiting for input, cancel it
        inputBuffer = ""
        finishInput();
      }
      removeCaret();

      await pyodide.runPythonAsync(wrapUserCode(codeEl.value));
      setStatus("Done");
    } catch (e) {
      setStatus("Error");
      writelnToConsole(String(e));
    } finally {
      runBtn.disabled = false;
      consoleEl.focus();
    }
  };

  consoleEl.focus();
</script>
</body>
</html>
